# Моментальные снимки и восстановление к ним: Linux+BTRFS+Snapper
*Как перестать бояться экспериментировать с системой*

## TLDR

Описан процесс установки linux, настройки раздела btrfs и утилиты Snapper с указанием основных известных мне граблей. Ну и немного соплей и рассуждений.

## Зачем это

С 2011 года я использовал разные дистрибутивы linux, в основном Ubuntu (Mint, Xubuntu и т.п.) и OpenSUSE. Совсем не по душе пришлись Fedora/CentOS. Тупо ниасилил gentoo и arch. 

Когда я только начинал работать с linux, как с десктопной ОС, это был непрекращающийся поток боли. Всё отваливалось. И на железе и в виртуальной машине. Хорошо было бы это списать на кривые руки, но нет.     

<spoiler title="Длинное перечисление проблем">

### ШГ

Шрифты били палкой по глазам, а установка infinality patch обязательно ломала какую-нибудь мелочь. Обязательно конфликтовали PPA, но они были нужны потому что в основных репозиториях было старье или в принципе не было ("Ой, ну мы такие все свободные, не можем же мы пакеты с MIT лицензией использовать"). В Ubuntu традиционно почти каждый релиз ломал переключение раскладок, особенно по Ctrl-Shift и Alt-Shift, а в OpenSuse ломалось всё с самой установки. Попытки исправить что-то одно раздражающее в теме запросто приводят к тому, что Xorg или Wayland не грузится совсем и давай, дружок, исправляй в консоли. А для того чтобы исправить шрифт по умолчанию запросто может оказаться, что требуется исправление в 4 местах и то, процессы запускаемые в sudo отображаются криво. Причем всё это еще и замаскировано хитро. Типа btrfs в целом работает, но только не на тонких LVM-томах. Или conky (это мониторинг десктопный такой) работает, но чтобы корректно обновлялся на xfce нужно потанцевать с бубном. Всё в отдельности работает, но не вместе. Или после обновления пакета A отваливается взаимодействие пакетов B и С.

Со временем некоторые проблемы постепенно уходят, например, с шрифтами, их сглаживанием и хинтингом ситуация становится всё лучше и лучше.  

### раскладка
(в linux баян с этим [длится](https://bugs.freedesktop.org/show_bug.cgi?id=865) с 2004 года)


### Skype

Он умирал несколько раз

</spoiler>

Не, ну я, конечно, слегка сгущаю краски, но суть та же: отстрелить себе можно всё и быстро. И это не бага. Это главная фича и обратная сторона вседозволенности. Ты можешь делать что угодно, но тебе и принимать отвественость за решение. Обвинить "криворуких рэдмондовцев" не получится. Это создаёт очень интересное перераспределение того, что умеют утилиты в Linux и Windows.

Но есть с этой вседозволенностью один нюанс: хочется, чтобы всегда был "план Б". Я в общем-то не против экспериментов, падений и восстановлений, но хочется, чтобы из-за исправления некрасивой буквы ["Г" в шрифте](https://bugs.launchpad.net/ubuntu-font-family/+bug/784549) не пришлось переустанавливать ОС, а можно было просто вернуться. И ведь есть, есть уже придуманное решение. Под виндой - системные точки восстановления. Под macOS - Time Machine. И даже есть похожий механизм в Linux, например есть моментальные снимки в LVM и в COW-файловых системах, в частности btrfs. Но с этими моментальными снимками не всё так просто.

Есть ровно один известный мне дистрибутив, в котором есть "из коробки" управление этими "точками восстановления". OpenSUSE, в ней есть утилита snapper - диспетчер этих точек восставновления и достаточно специфичное разбиение раздела. Но этот дистрибутив не нравится мне почти всем остальным (дурацкий YaST, странный zipper, нестабильная работа, рендеринг шрифтов, множество недоработок). Теоретически можно установить snapper и в других ОС, но в них нет автоматических снимков при установке/удалении программ, да и btrfs настроен неоптимально - это важно, так как в btrfs по умолчанию все операции записи copy-on-write, а это достаточно ресурсоёмко. Теоретически можно обойтись без snapper: например полумертвый проект apt-btrfs-snapshot или самому запилить, но тогда придётся вручную делать многие операции. Так я в общем-то и поступил, но оставалась какая-то заноза неудовлетворенности.  

**Важно:** эти снимки не заменяют бэкапы. Вернуться к снимку вы можете если снимок корректен, если файловая система не развалилась, если носитель работоспособен, если не перепутаете снимки, если не удалите их случайно. Наоборот тоже не работает: перед обновлением одного маленького пакета делать бэкап всего раздела как-то расточительно. В общем, снимок не бэкап, а бэкап не снимок.

## Почему это так

На первый 

И вот, когда в Ubuntu опять поломали переключение раскладок, я решил попробовать лечить новым средством. Я решил ставить antergos. Почему? Аntergos - это такой интересный дистрибутив на основе Arch linux, но главное отличие в том, что есть нормальный графический установщик (cnchi) и сама установка не похожа на смесь призыва злых духов и приготовления хлеба, если есть только молоток, нож и лопата. Arch/Antergos меня сразу подкупил количеством документации и лёгким решением всех моих предыдущих головняков. Да, там весьма необычный пакетный менеджер. Да, там "стабильные" пакеты вчера из git, а "нестабильные", обновляются чуть ли не тогда, когда разработчик push в git делает. А то и раньше. То есть на "энтерпрайзную стабильность" тут надеяться как-то опреметчиво.

Еще из плюсов Antergos:
- Его поддерживает [JetBrains](https://www.jetbrains.com/)
- Драйвера гостя для VirtualBox встают сразу же. Это удобно для экспериментов.
- Шрифты - нормально выглядят.
- GNOME с плоской темой выглядит замечательно.
- Всё свежее. 

Но. оказалось, что и здесь есть... эм... нюансики. Вот в этом репозитории я и пытаюсь собрать скрипты и рекомендации для лечения *геморройчиков*.

#### Откуда дровишки

У antergos свой установщик [cnchi](https://github.com/Antergos/Cnchi), написанный с 0. На python. Так вот установщик очень активно развивается и допиливается. Всё бы хорошо, но при установке он обновляется чуть ли не с git. В некоторых случаях при этом обновлении часть зеркал для устаноки используются некорректно. Я пока не стал бороться с обновлениями, а просто решил использовать заведомо шустрые зеркала.

- [Как обновлять список зеркал](https://antergos.com/wiki/uncategorized/how-to-choose-your-mirrors-before-installing-antergos/), на [русском](https://antergos.com/wiki/ru/uncategorized/how-to-choose-your-mirrors-before-installing-antergos/) не смотрите, сломаете глаз
- [Как выбирать быстрые зеркала](http://unixa.ru/korotko-o-glavnom-./arch-rankmirrors-ili-delaem-mirrorlist-aktualnyim-i-byistryim.html)
- [Оригинальная документация Arch](https://wiki.archlinux.org/index.php/mirrors)

Проблемы:
- в примере "Как обновлять список зеркал" у меня не не было файла `antergos-mirrorlist.pacnew`
- `rankmirrors` с `antergos-mirrorlist` не заработал. Надо проверить, как ранжируются зеркала в `cnchi`

Скрипты:
- [set-mirrors.sh](../scripts/set-mirrors.sh) - копирует заранее созданные файлы `antergos-mirrorlist` и `mirrorlist`
- [update-mirrors.sh](../scripts/set-mirrors.sh) - попытка автоматизированно получить самые быстрые зеркала.

Не забыть: 
- Установить `chmod +x` скриптам
- При запуске не пересортировывать зеркала. 
- [Yandex](https://yandex.ru/) - спасибо за ультрабыстрые зеркала репозиториев
- Посмотреть, можно ли в cnchi оптимизировать загрузку и отремонтировать прогресс-бар

#### Разбить диск

Дальше надо разбить диск. Тут в установке есть одна интересная хитрость. Я активно пользуюсь несколькими ОС, в том числе не могу снести Windows. У меня в системном блоке несколько HDD и SSD. А так как мне всё равно придётся настраивать мультизагрузку, и Linux вполне переживает загрузку то в VM, то в железе, то есть смысл подключить **физический** диск (SSD) в VirtualBox и там уже устанавливать. Плюсов тут несколько: 
- Пока устанавливается ОС можно ~~подрочить~~ спокойно заниматься своими делами. 
- Если что-то пошло не так, можно загуглить проблему или заранее подготовить скрипты (как собственно, я сейчас и делаю)
- Установщик не имеет шансов запоганить загрузку остального зоопарка. После установки придётся настраивать мультизагрузку, но с этим проще бороться, когда лишь одна из трёх систем не грузится, а не когда ничего не работает.
- Загрузка и установка с образа на HDD/SSD быстрее чем с флэшки и уж тем более с DVD (что такое DVD???). Это важно, потому что cnchi устанавливается неспешно.

Добрые советы:
- При работе с физическим диском VirtualBox в Windows придётся запускать из-под администратора.
- НЕ ВКЛЮЧАЙТЕ кеширование IO диска в настройках виртуальной машины. Если придётся снимать процесс VM, то есть неплохие шансы убить файловую систему.
- НЕ ИСПОЛЬЗУЙТЕ сохранение состояния и снимки. Так тоже можно убить файловую систему (забыл, что виртуальную машину не выключил, а засуспендил, загрузился с диска и привет - так я однажды и сделал).
- Вам в случае такой установки нужно будет отдельно устанавливать некоторые драйвера после установки.   

В любом случае у меня несколько дисков, часть из них hdd, часть ssd, а есть еще диск загрузки. Для того, чтобы посмотреть, какие диски у нас есть использую `lsblk`. Так выглядит в VM
```
[antergos@ant-17.10 ~]$ lsblk                                             
NAME  MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
loop0   7:0    0  1.8G  1 loop /run/archiso/sfs/root-image
sda     8:0    0  128G  0 disk 
sr0    11:0    1  1.9G  0 rom  /run/archiso/bootmnt
[antergos@ant-17.10 ~]$ 
```

Дальше я считаю, что тот самый диск, на который ставим систему - sda. Для однократной разбивки можно было бы пользоваться `gparted`, но я хочу сделать воспроизводимую установку. Так что только `parted`. 

1. Два раза проверяю, что диск именно тот. Мы сейчас собираемся его очистить. 
2. На диске создаём таблицу разделов gpt. Установщик Antergos, если делать вручную, заботливо предупреждает *"GRUB требует, чтобы загрузочный раздел в BIOS системах содержал файл core.img из-за отсутствия пропуска после таблицы в GPT дисках.\n\nCnchi создаст этот загрузочный раздел BIOS за вас."*. Подробнее [тут](https://wiki.archlinux.org/index.php/GRUB_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)). Если не вручную, то раздел с `bios_grub` стоит сделать самому.
3. Кроме `bios_grub` я создаю (как подключать - кажется очевидно):
- swap (примерно с память размером)
- boot - ext4 - 4 ГБ, хотя это весьма избыточно
- root - btrfs - именно тут будет работать snapper
- home - btrfs
4. Заскриптовано [тут](../scripts/init-disk.sh)
5. Тут я столкнулся с [печалькой](https://github.com/Antergos/Cnchi/issues/812). Приходится делать какие-то лишние ручные действия.

Дальше устанавливаем ОС.

Подгоним разбивку root-раздела под снимки

#### Прочие мелочи

##### Жирные пакеты в AUR 

Пакеты в AUR иногда большие. Очень большие. А `/tmp` в памяти и ограничен. [Опции](https://archlinuxarm.org/forum/viewtopic.php?f=57&t=8812):
- Увеличить `/tmp`
- Собирать не в tmp
    
##### chmod+x в Windows 

При написании этих скриптов возникла проблемочка: писал я их частично в Windows, а в этом случае они прилетали в репозиторий не как выполняемые файлы.

Решение
```
> git add .
> git ls-files --stage
100644 012c4ba239ecdbd15c70c05b9306c32175dc8c5c 0       file.sh
> git update-index --chmod=+x file.sh
> git commit -m "executable"
[master c6e8134] executable
 1 files changed, 1 insertions(+), 1 deletion(-)
 mode change 100644 => 100755 scripts/file.sh
> git ls-files --stage
100755 012c4ba239ecdbd15c70c05b9306c32175dc8c5c 0       file.sh
```





